# Модель банкомата (ATM)

Лабораторная работа №1 по дисциплине «Проектирование программного обеспечения интеллектуальных систем»


## О проекте

Программа моделирует работу банкомата с интерфейсом командной строки (CLI).  
Поддерживает три режима: клиент, инкассатор и технический специалист.  
Реализована симуляция оборудования, аутентификация, транзакции, сохранение состояния между запусками.

**Основные возможности**:
- Аутентификация по карте (16 цифр) и PIN; с картой хранится срок действия (MM/YY)
- Клиентские операции: просмотр баланса, снятие, внесение, перевод, оплата услуг, смена PIN
- Таймер неактивности: после заданного в Config времени без ввода (SESSION_TIMEOUT_SECONDS, по умолчанию 120 с) сессия завершается: клиент — возврат к вводу номера карты; инкассатор/техник — возврат в меню выбора типа сессии
- Звуковая обратная связь (SoundPlayer): в лог пишется *Beep* после успешной операции или ошибки
- Результаты операций (Check Balance, Withdraw и др.) отображаются на экране; после каждого действия — «Press Enter to continue»
- Инкассация: пополнение и изъятие наличных
- Техническое обслуживание: извлечение карт, перезагрузка
- Сохранение состояния в JSON; обработка ошибок через исключения; PEP 8 и аннотации типов
- Unit-тесты (покрытие 87%+)

**Стек**:
- Python 3.10+
- pytest, pytest-cov (тесты)

## Структура проекта

- `src/atm/` — исходный код пакета банкомата
- `src/main.py` — точка входа при запуске из `src`
- `data/` — каталог данных (создаётся при первом запуске в корне ATM)
- `tests/` — модульные и интеграционные тесты

## Сохранение данных (JSON)

Состояние системы сохраняется между запусками.

**Расположение**: каталог `data/` в корне проекта ATM. Путь задаётся относительно пакета и не зависит от текущей рабочей директории.

**Файлы**:
- `data/bank_accounts.json` — счета и карты: номер карты (16 цифр), хэш PIN, баланс, флаг блокировки (`is_blocked`), флаг изъятия (`is_retained` — карта изъята банкоматом и находится в машине), срок действия (expiry_date). При первом запуске создаётся файл с демо-счетами. Если остался старый файл с короткими номерами карт — удалите его, чтобы создались новые 16-значные счета.
- `data/atm_state.json` — состояние кассет банкомата. Обновляется при выдаче/приёме наличных, пополнении и изъятии инкассатором.

**Блокировка и изъятие карт**:
- **3 неверных PIN** — карта блокируется (`is_blocked: true`) и изымается (`is_retained: true`).
- **Вставка заблокированной карты** — сразу сообщение «Card is blocked», карта изымается, в JSON ставится `is_retained: true`.
- **Ввод номера уже изъятой карты** — сообщение «Card already retained. Such thing cannot happen.» (такой карты не может быть вставлена).
- **Техник (1 Collect retained cards)** — видит список изъятых карт (по `is_retained` в JSON и по текущему сеансу), при сборе карты помечаются как не изъятые и разблокированные (`is_retained: false`, `is_blocked: false`).

## Запуск

Из каталога `ATM`:
```bash
cd labs/lab_1/ATM
PYTHONPATH=src python3 -m atm.main
```
или из `ATM/src`:
```bash
cd labs/lab_1/ATM/src
PYTHONPATH=. python3 main.py
```

## Демо-счета (для проверки)

При отсутствии `data/bank_accounts.json` создаются учётные записи. **Номер карты — строго 16 цифр.** С картой хранится срок действия (expiry_date, например 12/28).

| Роль       | Номер карты         | PIN   | Описание        |
|------------|---------------------|-------|-----------------|
| Клиент     | 1234567890123456    | 0000  | Баланс 10000 BYN |
| Клиент     | 1111111111111111    | 1234  | Баланс 5000 BYN  |
| Заблокированная | 9999999999999999 | 0000  | Карта заблокирована |
| Инкассатор | 1000000000000001    | 1111  | Режим пополнения/изъятия |
| Техник     | 1000000000000002    | 2222  | Режим техобслуживания |

## Меню клиента (после ввода PIN)

1. Check Balance — показать баланс (результат на экране, затем *Beep* в логе, Enter).
2. Withdraw — снятие наличных (результат на экране, звук, Enter).
3. Deposit — внесение наличных.
4. Transfer — перевод на другую карту (16 цифр).
5. Payment (services) — оплата услуг (название услуги и сумма).
6. Pin Change — смена PIN.
7. Exit — завершение сессии.

## Как показать преподавателю

1. **Клиент**: Запустить → `1` (Client) → карта `1234567890123456` → PIN `0000` → в меню: 1 (баланс), 2 (снятие), 4 (перевод), 5 (оплата) и т.д. Результаты видны на экране; в логе `data/atm.log` — *Beep* после операций.
2. **Заблокированная карта**: `1` → карта `9999999999999999` → сообщение о блокировке, карта «изъята».
3. **Инкассатор**: `2` → карта `1000000000000001`, PIN `1111` → меню: 1 Replenish, 2 Collect, 3 Replace cassette, 4 Exit.
4. **Техник**: `3` → карта `1000000000000002`, PIN `2222` → 1 Collect retained cards, 2 Reboot, 3 Exit.
5. **Сохранение**: Сделать снятие/перевод → выйти → снова запустить → клиент, карта `1234567890123456` → проверить баланс; открыть `data/bank_accounts.json` и `data/atm_state.json`.

## Тесты

```bash
cd labs/lab_1/ATM
pip install -r requirements-dev.txt
PYTHONPATH=src python3 -m pytest tests/ -v --cov=src/atm --cov-report=term-missing -c pyproject.toml
```
Покрытие: 87%