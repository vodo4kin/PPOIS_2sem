@startuml Class_Diagram
skinparam monochrome true
skinparam shadowing false
skinparam dpi 300
skinparam packageStyle rectangle

package "UserInterfaceModule" {
  class Display
  class Keypad
  class SessionTimer
  class SoundPlayer
}

package "CardReaderModule" {
  class CardReader
  class Card
  class CardRetainer
}

package "AuthenticationModule" {
  class AuthenticationService
  class PinValidator
  class CardBlockStatusChecker
}

package "TransactionModule" {
  abstract class Transaction
  class TransactionFactory
  class WithdrawalTransaction
  class DepositTransaction
  class BalanceInquiryTransaction
  class PinChangeTransaction
  class TransferTransaction
  class PaymentTransaction
}

package "CashHandlingModule" {
  class CashDispenser
  class CashAcceptor
  class CashInventory
}

package "CashManagementModule" {
  class CashReplenisher
  class CashCollector
  class CassetteManager
  class CashReplenisherAuthenticator
}

package "TechnicianServiceModule" {
  class RetainedCardCollector
  class PowerController
  class RebootController
  class TechnicianAuthenticator
}

package "BankCommunicationModule" {
  class BankGateway
  class MockBankRepository
  class AccountData
}

package "PowerAndHardwareModule" {
  class PowerManager
}

package "SessionManager" {
  class ATMStateMachine
  class Session
  class SessionType
  class State
  class StateSaver
  class Logger
}

package "Сквозные" {
  class ATM
  class Config
}

' Центральные связи
ATM *-- Logger
ATM *-- AuthenticationService
ATM *-- ATMStateMachine
ATM *-- Session
ATM *-- BankGateway
ATM *-- CardReader
ATM *-- Display
ATM *-- Keypad
ATM *-- SessionTimer
ATM *-- SoundPlayer
ATM *-- CashInventory
ATM *-- CashDispenser
ATM *-- CashAcceptor
ATM *-- CashReplenisher
ATM *-- CashCollector
ATM *-- CassetteManager
ATM *-- PowerController
ATM *-- RebootController
ATM *-- RetainedCardCollector

' Транзакции
TransactionFactory ..> Transaction : создаёт
Transaction <|-- WithdrawalTransaction
Transaction <|-- DepositTransaction
Transaction <|-- BalanceInquiryTransaction
Transaction <|-- PinChangeTransaction
Transaction <|-- TransferTransaction
Transaction <|-- PaymentTransaction

' Карты
CardReader ..> Card : читает
CardReader *-- CardRetainer : управляет удержанием

' Аутентификация
AuthenticationService *-- PinValidator
AuthenticationService *-- CardBlockStatusChecker
AuthenticationService ..> BankGateway : запрашивает

' Наличные
CashDispenser ..> CashInventory : уменьшает
CashAcceptor ..> CashInventory : увеличивает
CashReplenisher ..> CashInventory : увеличивает (пополнение)
CashCollector ..> CashInventory : уменьшает (изъятие)
CassetteManager ..> CashInventory : управляет кассетами

' Инкассатор и техник
CashReplenisherAuthenticator ..> AuthenticationService : авторизация
TechnicianAuthenticator ..> AuthenticationService : авторизация

' Банк
BankGateway *-- MockBankRepository
MockBankRepository ..> AccountData : хранит

' Состояния и сессии
ATMStateMachine *-- State
Session *-- SessionType
CashInventory ..> StateSaver : сохранение состояния кассет

' Настройки
Config ..> ATM : конфигурация

@enduml